Option Compare Database
Option Explicit

Const SYS_OR_HIDDEN = dbSystemObject Or dbHiddenObject



'——————————————————————————————————————————————
' Exports one table's field definitions and a set of sample rows to CSV files.
'
' Parameters:
'   TableName      - name of the table to export
'   SampleRowCount - how many rows of data to export (default 10)
'   OutputFolder   - folder path where CSVs will be written (defaults to current DB folder)
'——————————————————————————————————————————————
Public Sub ExportTableSchemaAndSampleData( _
    ByVal TableName As String, _
    Optional ByVal SampleRowCount As Long = 10, _
    Optional ByVal OutputFolder As String = "" _
)
'keep
    Dim db    As DAO.Database
    Dim td    As DAO.TableDef
    Dim f     As DAO.Field
    Dim idx   As DAO.Index
    Dim pkFlds As Collection
    Dim rs    As DAO.Recordset
    Dim schemaFile As String
    Dim dataFile   As String
    Dim outSchema  As Integer
    Dim outData    As Integer
    Dim i As Long, rowCount As Long
    Dim val As Variant
    
    '— folder setup
    If Len(OutputFolder) = 0 Then
        OutputFolder = CurrentProject.path
    End If
    If Right(OutputFolder, 1) <> "\" Then OutputFolder = OutputFolder & "\"
    
    schemaFile = OutputFolder & TableName & "_Schema.csv"
    dataFile = OutputFolder & TableName & "_DataSample.csv"
    
    Set db = CurrentDb
    Set td = db.TableDefs(TableName)
    
    '— collect PK field names
    Set pkFlds = New Collection
    For Each idx In td.Indexes
        On Error Resume Next
        If idx.Primary = True Then
            For Each f In idx.Fields
                pkFlds.Add f.Name, f.Name
            Next
        End If
        On Error GoTo 0
    Next
    
    '— open schema CSV
    outSchema = FreeFile
    Open schemaFile For Output As #outSchema
    Print #outSchema, "FieldName,FieldType,FieldSize,Required,IsPrimaryKey"
    
    '— write each field
    For Each f In td.Fields
        Print #outSchema, _
            """" & f.Name & """," & _
            """" & FieldTypeName(f.Type) & """," & _
            f.Size & "," & _
            IIf(f.Required, "Yes", "No") & "," & _
            IIf(ItemInCollection(pkFlds, f.Name), "Yes", "No")
    Next
    Close #outSchema
    
    '— open data CSV
    outData = FreeFile
    Open dataFile For Output As #outData
    
    '— header row
    Dim hdr As String
    hdr = ""
    For Each f In td.Fields
        hdr = hdr & """" & f.Name & ""","
    Next
    hdr = Left(hdr, Len(hdr) - 1)
    Print #outData, hdr
    
    '— write sample rows
    Set rs = db.OpenRecordset(TableName, dbOpenSnapshot)
    rowCount = 0
    Do While Not rs.EOF And rowCount < SampleRowCount
        Dim line As String
        Debug.Print rs.recordcount
        line = ""
        For Each f In td.Fields
            val = rs.Fields(f.Name).Value
            Debug.Print val
            If IsNull(val) Then
                line = line & """" & """" & ","
            Else
                line = line & """" & Replace(CStr(val), """", """""") & ""","
            End If
        Next
        line = Left(line, Len(line) - 1)
        Print #outData, line
        
        rs.MoveNext
        rowCount = rowCount + 1
    Loop
    
    rs.Close
    Close #outData
    
   ' MsgBox "Exported schema to:" & vbCrLf & schemaFile & vbCrLf & _
           "Exported sample data to:" & vbCrLf & dataFile, vbInformation, "Export Complete"
End Sub

'——————————————————————————————————————————————
' Loops through all user tables (skips MSys and hidden) and exports each one.
'
' Parameters:
'   SampleRowCount - number of sample rows per table
'   OutputFolder   - where your CSV files go
'********'********************* call ExportAllTablesSchemaAndSampleData(10,"D:\ENVIRON_ERP\ExportsForChatGPT\TablesForChatGPT")

'——————————————————————————————————————————————
Public Sub ExportAllTablesSchemaAndSampleData( _
    Optional ByVal SampleRowCount As Long = 10, _
    Optional ByVal OutputFolder As String = "" _
)

    Dim db As DAO.Database
    Dim td As DAO.TableDef
    Const SYS_OR_HIDDEN = dbSystemObject Or dbHiddenObject
    
    Set db = CurrentDb
    For Each td In db.TableDefs
        ' 1) skip any MSys* table by name
        If Left$(td.Name, 4) = "MSys" Then GoTo NextTable
        
        ' 2) skip system or hidden tables by attributes
        If (td.Attributes And SYS_OR_HIDDEN) <> 0 Then GoTo NextTable
        
        ' 3) safe to export
        Call ExportTableSchemaAndSampleData(td.Name, SampleRowCount, OutputFolder)
        
NextTable:    ' < this is the label you jumped to
    Next td
    
    'MsgBox "All tables processed.", vbInformation, "Done"

    
End Sub

'——————————————————————————————————————————————
' Helper: convert DAO type constant to human-readable name
'——————————————————————————————————————————————
Private Function FieldTypeName(t As Integer) As String
'keep
    Select Case t
        Case dbText:          FieldTypeName = "Text"
        Case dbLong:          FieldTypeName = "Long Integer"
        Case dbInteger:       FieldTypeName = "Integer"
        Case dbDouble:        FieldTypeName = "Double"
        Case dbDate:          FieldTypeName = "Date/Time"
        Case dbCurrency:      FieldTypeName = "Currency"
        Case dbBoolean:       FieldTypeName = "Yes/No"
        Case dbMemo:          FieldTypeName = "Memo"
        Case dbGUID:          FieldTypeName = "GUID"
        Case dbLongBinary:    FieldTypeName = "OLE Object"
        Case Else:            FieldTypeName = "Other(" & t & ")"
    End Select
End Function

'——————————————————————————————————————————————
' Helper: tests if key exists in a Collection
'——————————————————————————————————————————————
Private Function ItemInCollection(col As Collection, key As String) As Boolean
'keep
    On Error Resume Next
    ItemInCollection = (Not col(key) Is Nothing)
    On Error GoTo 0
End Function


'——————————————————————————————————————————————
' Export relationships + metadata to CSV:
'   PrimaryTable,ForeignTable,RelationName,Cardinality,
'   FieldMappings,CascadeDelete,CascadeUpdate,PrimaryIndex,ForeignIndex
'********************* Use the following code to immereate window : Call ExportRelationshipsCleanNames("D:\ENVIRON_ERP\ExportsForChatGPT\RelationshipsForChatGPT\MyDB_Rels_Metadata.csv")

'——————————————————————————————————————————————
Public Sub ExportRelationshipsWithMetadata(ByVal OutputFile As String)
'keep
    Dim db        As DAO.Database
    Dim rel       As DAO.Relation
    Dim f         As DAO.Field
    Dim out       As Integer
    Dim maps      As String
    Dim card      As String
    Dim displayName As String
    Dim deleteCascade As String, updateCascade As String
    Dim pkFields() As String, fkFields() As String
    Dim i As Long, fldCount As Long
    Dim td       As DAO.TableDef
    Dim idx      As DAO.Index
    Dim isMatch  As Boolean
    Dim primaryIndexName As String, foreignIndexName As String

    Set db = CurrentDb
    out = FreeFile
    Open OutputFile For Output As #out

    ' Header
    Print #out, "PrimaryTable,ForeignTable,RelationName,Cardinality," & _
                "FieldMappings,CascadeDelete,CascadeUpdate," & _
                "PrimaryIndex,ForeignIndex"

    For Each rel In db.Relations
        If Left(rel.Name, 4) <> "MSys" Then
            ' Clean logical name
            If InStr(rel.Name, "]") > 0 Then
                displayName = Mid(rel.Name, InStr(rel.Name, "]") + 1)
                If Left(displayName, 1) = "." Then
                  displayName = Mid(displayName, 2)
                End If

            Else
                displayName = rel.Name
            End If

            ' Build mapping string and collect fields arrays
            maps = ""
            fldCount = rel.Fields.Count
            ReDim pkFields(1 To fldCount)
            ReDim fkFields(1 To fldCount)
            For i = 1 To fldCount
                Set f = rel.Fields(i - 1)
                maps = maps & f.Name & ">" & f.ForeignName & ";"
                pkFields(i) = f.Name
                fkFields(i) = f.ForeignName
            Next i
            If Right(maps, 1) = ";" Then maps = Left(maps, Len(maps) - 1)

            ' Cardinality
            If (rel.Attributes And dbRelationUnique) <> 0 Then
                card = "1-to-1"
            Else
                card = "1-to-many"
            End If

            ' Cascade flags
            deleteCascade = IIf((rel.Attributes And dbRelationDeleteCascade) <> 0, "Yes", "No")
            updateCascade = IIf((rel.Attributes And dbRelationUpdateCascade) <> 0, "Yes", "No")

            ' Find PrimaryIndex on rel.Table matching pkFields
            primaryIndexName = ""
            Set td = db.TableDefs(rel.Table)
            For Each idx In td.Indexes
                If idx.Primary Then
                    If idx.Fields.Count = fldCount Then
                        isMatch = True
                        For i = 1 To fldCount
                            If idx.Fields(i - 1).Name <> pkFields(i) Then
                                isMatch = False: Exit For
                            End If
                        Next i
                        If isMatch Then
                            primaryIndexName = idx.Name
                            Exit For
                        End If
                    End If
                End If
            Next

            ' Find ForeignIndex on rel.ForeignTable matching fkFields
            foreignIndexName = ""
            Set td = db.TableDefs(rel.ForeignTable)
            For Each idx In td.Indexes
                If Not idx.Primary Then
                    If idx.Fields.Count = fldCount Then
                        isMatch = True
                        For i = 1 To fldCount
                            If idx.Fields(i - 1).Name <> fkFields(i) Then
                                isMatch = False: Exit For
                            End If
                        Next i
                        If isMatch Then
                            foreignIndexName = idx.Name
                            Exit For
                        End If
                    End If
                End If
            Next

            ' Output CSV line
            Print #out, _
              rel.Table & "," & _
              rel.ForeignTable & "," & _
              displayName & "," & _
              card & "," & _
              """" & maps & """" & "," & _
              deleteCascade & "," & _
              updateCascade & "," & _
              primaryIndexName & "," & _
              foreignIndexName
        End If
    Next

    Close #out
   ' MsgBox "Relationships + metadata exported to:" & vbCrLf & OutputFile, vbInformation, "Done"
End Sub


Public Sub ExportObjectsAsText_AppModel( _
    Optional ByVal OutputFolder As String = "" _
)
'keep
'********************* Use the following code to immereate window : ExportObjectsAsText_AppModel("D:\ENVIRON_ERP\ExportsForChatGPT\FormsQueriesAndMacrosForChatGPT")
    Dim fsoPath As String
    Dim obj     As AccessObject
    Dim qdf     As DAO.QueryDef
    Dim tdf     As DAO.TableDef
    
    ' 1) Determine or create output folder
    If Len(OutputFolder) = 0 Then
        fsoPath = CurrentProject.path & "\TextExports\"
    Else
        fsoPath = OutputFolder
    End If
    If Right(fsoPath, 1) <> "\" Then fsoPath = fsoPath & "\"
    If Dir(fsoPath, vbDirectory) = "" Then MkDir fsoPath
    
    ' 2) Forms
    For Each obj In CurrentProject.AllForms
        Application.SaveAsText _
          Access.AcObjectType.acForm, _
          obj.Name, _
          fsoPath & "Form_" & obj.Name & ".txt"
    Next
    
    ' 3) Reports
    For Each obj In CurrentProject.AllReports
        Application.SaveAsText _
          Access.AcObjectType.acReport, _
          obj.Name, _
          fsoPath & "Report_" & obj.Name & ".txt"
    Next
    
    ' 4) Queries
    For Each qdf In CurrentDb.QueryDefs
        Application.SaveAsText _
          Access.AcObjectType.acQuery, _
          qdf.Name, _
          fsoPath & "Query_" & qdf.Name & ".txt"
    Next
    
    ' 5) Macros
    For Each obj In CurrentProject.AllMacros
        Application.SaveAsText _
          Access.AcObjectType.acMacro, _
          obj.Name, _
          fsoPath & "Macro_" & obj.Name & ".txt"
    Next
    
    ' 6) Tables (skip system & linked tables)
    For Each tdf In CurrentDb.TableDefs
        If (tdf.Attributes And dbSystemObject) = 0 Then
            If Len(tdf.Connect) = 0 Then
                Application.SaveAsText _
                  Access.AcObjectType.acTable, _
                  tdf.Name, _
                  fsoPath & "Table_" & tdf.Name & ".txt"
            End If
        End If
    Next
    
   ' MsgBox "All objects exported to:" & vbCrLf & fsoPath, vbInformation, "Done"
End Sub